name: Docker Build Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create .env file
        run: |
          cp .env.example .env || echo "WEB_PORT=8080" > .env
          echo "WEB_PORT_ALT=8081" >> .env
          echo "MYSQL_PORT=3306" >> .env
          echo "MYSQL_ROOT_PASSWORD=test_password" >> .env
          echo "MYSQL_DATABASE=test_db" >> .env
          echo "MYSQL_USER=test_user" >> .env
          echo "MYSQL_PASSWORD=test_password" >> .env
          echo "PMA_PORT=8888" >> .env
      
      - name: Build Docker Compose
        run: docker compose build --no-cache
      
      - name: Start Services
        run: docker compose up -d
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          sleep 15
          docker compose ps
      
      - name: Check service health
        run: |
          # Check if containers are running
          docker compose ps | grep -q "Up" || exit 1
          echo "✅ All services are running"
      
      - name: Test web service
        run: |
          # Wait a bit more for Apache to fully start
          sleep 5
          # Check if web service responds (optional, may fail if service needs more time)
          curl -f http://localhost:8080 || echo "⚠️ Web service check skipped (may need more time)"
      
      - name: Cleanup
        if: always()
        run: docker compose down -v
